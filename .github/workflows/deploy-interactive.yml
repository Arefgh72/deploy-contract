name: Deploy Interactive UI to GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies and Build
        run: |
          pip install -r requirements.txt
          npm install @openzeppelin/contracts sol-merger
          python build.py

      - name: Prepare Ethers.js for Deployment
        run: |
          mkdir -p public/lib
          curl -L https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js -o public/lib/ethers.umd.min.js
          ls -l public/lib/  # بررسی وجود فایل

      - name: Organize files for deployment
        run: |
          mkdir -p public
          cp index.html ./public/ || echo "No index.html found"
          cp deploy-ui.js ./public/ || echo "No deploy-ui.js found"
          cp artifacts.json ./public/ || echo "No artifacts.json found"
          cp -r flattened ./public/ || echo "No flattened directory found"
          cp verification_*.json ./public/ || echo "No verification files found"
          ls -R public/  # بررسی فایل‌ها

      - name: Set Git user identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Install gh-pages
        run: npm install -g gh-pages

      - name: Deploy UI to GitHub Pages
        run: gh-pages -d public -b deploy-contract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
